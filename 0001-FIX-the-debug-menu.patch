From ca27249f71312c1a22909a74b2dd9f54abc14ace Mon Sep 17 00:00:00 2001
From: Dan Radu <officeradu@yahoo.com>
Date: Fri, 22 Jan 2021 18:23:06 +0100
Subject: [PATCH] FIX the debug menu

---
 software/front/US_Firmware.X/menu.c | 21 +++------------------
 software/front/US_Firmware.X/menu.h |  1 -
 software/front/US_Firmware.X/pars.h |  8 +++++---
 3 files changed, 8 insertions(+), 22 deletions(-)

diff --git a/software/front/US_Firmware.X/menu.c b/software/front/US_Firmware.X/menu.c
index 7749f28..7a6166e 100644
--- a/software/front/US_Firmware.X/menu.c
+++ b/software/front/US_Firmware.X/menu.c
@@ -256,9 +256,6 @@ void OLEDTasks(){
                                 case 19: //Version info
                                     CMode=VERSION_INFO;
                                     break;
-                                case 20: //debug switch
-                                    CMode=DEBUG_SWITCH;
-                                    break;
                                 default:
                                     CMode=SET_PARAMS;
                                     break;
@@ -353,18 +350,6 @@ void OLEDTasks(){
                     }
                     OLEDFlags.f.Version = 1;
                     break;
-                  case DEBUG_SWITCH: //change variable for enable deubg
-                    ModeTicks = 250;
-                    if(BTicks[1].o && !BTicks[1].n){
-                        CMode = DEFAULT_MENU;
-                        break;
-                    }
-                    OLEDPrintNum816(0, 0, 3, 666); //Test
-                    OLEDUpdate();     
-                    _delay_ms(2000);
-                    break;
-                                      
-                    
                     
                 case STANDBY: //stand-by
                     if(((pars.WakeUp & 1) && BTicks[1].o <= 50 && BTicks[1].n > 50) ||
@@ -463,7 +448,7 @@ void OLEDTasks(){
     
     if(OLEDFlags.f.Pars){
         int i, par = CPar - CRow;
-        if(par < 0) par += NB_OF_MENU_PARAMS);
+        if(par < 0) par += NB_OF_MENU_PARAMS;
         for(i=0; i < 4; i++){
             int p = MenuOrder[par];
             OLEDPrint816(0, i * 2, ParDef[(UINT8)MenuOrder[(UINT8)par]].Name, 11);
@@ -478,7 +463,7 @@ void OLEDTasks(){
                 }
             }
             par++;
-            if(par >= NB_OF_MENU_PARAMS)) par -= NB_OF_MENU_PARAMS);
+            if(par >= NB_OF_MENU_PARAMS) par -= NB_OF_MENU_PARAMS;
         }        
     }
     
@@ -628,7 +613,7 @@ void MenuTasks(){
                     //if(BTicks[0].d) Enc += ((BTicks[0].n >> 6) + 1)<<2;
                     //if(BTicks[2].d) Enc -= ((BTicks[2].n >> 6) + 1)<<2;
                     if(BTicks[0].d) { Enc += 1; BTicks[0].d = 0;}
-                    if(BTicks[2].d) { Enc += 1; BTicks[2].d = 0;}
+                    if(BTicks[2].d) { Enc -= 1; BTicks[2].d = 0;}
                 }
                 else{
                     BTicks[0].o = 0;
diff --git a/software/front/US_Firmware.X/menu.h b/software/front/US_Firmware.X/menu.h
index 840dc47..db0658a 100644
--- a/software/front/US_Firmware.X/menu.h
+++ b/software/front/US_Firmware.X/menu.h
@@ -24,7 +24,6 @@ typedef enum{
     SET_INPUT_TYPE,       /*input selection*/
     TIP_CHANGE,           /*tip change*/
     VERSION_INFO,         /*version information*/
-    DEBUG_SWITCH,         /*Debug Switch*/
     STANDBY = 0xFF        /*standby*/
 }T_MENU_MODE;
 
diff --git a/software/front/US_Firmware.X/pars.h b/software/front/US_Firmware.X/pars.h
index 8256469..1a5c838 100644
--- a/software/front/US_Firmware.X/pars.h
+++ b/software/front/US_Firmware.X/pars.h
@@ -33,8 +33,10 @@ typedef union {
         UINT8 Cal;
         UINT8 Debug;
         UINT8 TempStep;                             //temperature step - 1=2C, 2=4C... 25=50C
+        UINT8 Version;                              //not used
+        UINT8 Dbg_menu;                             //additional debug menu
     };
-    UINT8 b[19];
+    UINT8 b[21];
 }pars_t;
 
 typedef struct {
@@ -48,11 +50,11 @@ typedef struct {
     void (*OLEDDispFunc)(int, int, int, int);
 }t_ParDef;
 
-#define NB_OF_MENU_PARAMS  (sizeof(MenuOrder) / sizeof(MenuOrder[0])
+#define NB_OF_MENU_PARAMS  (sizeof(MenuOrder) / sizeof(MenuOrder[0]))
 
 #ifndef _PARS_C
 extern const char MenuOrder[20];
-extern const t_ParDef ParDef[18]; //Menu default item
+extern const t_ParDef ParDef[21]; //Menu default item
 extern void LoadPars(void);
 extern void SavePars();
 #endif
-- 
2.27.0

